\documentclass{noiassignment}

\begin{document}

%% 解题报告开始

\title{AAQQZ 解题报告}
\author{宁波镇海蛟川书院~~卢啸尘}

\maketitle

\section{试题来源}

IOI2015日本队选拔赛(第三试): AAQQZ

\section{试题大意}

给出一个长为$N$的整数序列。允许选取一个连续子序列，将其按升序排序。

问得到的新序列中的最大连续回文子序列的长度的最大值。

$N, |\Sigma| \le 3000$。

\section{算法介绍}

首先我们考虑排序以后得到的有序子序列与之后得到的连续回文子序列之间有何关系。

1. 没有公共部分。注意到，至少有一种有序子序列被包含于回文子序列的方案能够得到同样的结果（从这个回文子序列中任取一个长为1的子序列即可）。从而不考虑此情况亦可。

2. 回文子序列被有序子序列完全包含。

3. 有序子序列被回文子序列完全包含。

4. 回文子序列和有序子序列交叉。考虑到我们可以对原序列$A_i$做以下变换得到新序列$A^\prime_i = |\Sigma| + 1 - A_{N+1-i}$，这里约定回文子序列在有序子序列的左侧。

\subsection{回文子序列被有序子序列完全包含的情形}

在这种情况下，回文子序列是有序子序列中某一段相等的元素。

统计每一种元素在整个序列中出现的次数。取其最大值就是这个情形的答案。

\subsection{剩下两种情形}

实际上这两种情形仍然可以被继续划分。

情形$a$. 有序子序列被回文子序列的一侧完全包含。在左侧完全包含的情形在变换后的序列中就是在右侧完全包含，因此这里约定有序子序列被包含在右侧。

情形$b$. 有序子序列被回文子序列完全包含，跨过了中心线。约定有序子序列与回文子序列左界的距离大于等于与右界的距离。

情形$c$，有序子序列的一部分在回文子序列的一侧内，另一部分在回文子序列外。根据前述约定这一侧是右侧。

情形$d$，有序子序列完整包含了回文子序列的一侧。根据前述这一侧是右侧。

定义记号$C_{i,j}$为以i为末尾的前缀的逆序串和以j为开头的后缀的LCP。它可以在$O(N^2)$中被预处理。

\subsection{第一类扫描过程}

我们考察情形$a$和情形$c$。明显地在回文子序列的左侧将有一段降序子序列，它对应了回文子序列右侧与有序子序列的相交部分。而在降序子序列和有序子序列之间是一段回文序列――它处在回文子序列的中心。

花$O(N)$的系数枚举中心线在哪里，利用记号$C$求出这段子回文子序列的长度，然后从子回文子序列的左侧找到一个尽可能长的降序子序列。

之后就是从子回文子序列的右侧向右扫描，在扫描的过程中维护与左侧相对应的长度。这可以通过以下两个值来计算出：右边的字符可以匹配多少长度；右边的最小多余字符的左侧最多可以有多少匹配的字符。

一次扫描结束以后就得到了情形$a$与情形$c$的结果。

注意当已扫描的所有右侧字符都可以匹配的时候要利用记号$C$处理情形$a$中降序子序列和升序子序列外侧的部分。

\subsection{第二类扫描过程}

我们考察情形$b$和情形$d$。分别类似于情形$a$和情形$c$，但是升序子序列的开头一段跨越了中心线，这一段的位置就类似于情形$a$和情形$c$中的中间子回文子序列。

那么整个过程就类似于第一类扫描过程，只不过这里允许至多一种小于左侧降序子序列末端字符的多余字符存在。

\subsection{算法流程}

1. 计算情形2；

2. 进行第一类扫描，计算出情形a和情形c；

3. 进行第二类扫描，计算出情形b和情形d；

4. 对序列做变换；

5. 进行第一类扫描，计算出情形a和情形c；

6. 进行第二类扫描，计算出情形b和情形d；
%% 解题报告结束

\end{document}
